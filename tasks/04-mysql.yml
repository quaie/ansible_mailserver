---
- name: check if password already changed
  shell: echo "show databases" | mysql -uroot
  failed_when: no 
  changed_when: no
  register: mysqlpass

- name: copy mysql_secure_installation
  block:
    - name: copy mysql_secure_installation
      template:
        dest: /tmp/sql
        src: templates/mysql_secure_installation.j2

    - name: run script
      shell: mysql -sfu root < "/tmp/sql"

    - name: delete mysql_secure_installation
      file:
        path: /tmp/sql
        state: absent
  when: "'mysql' in mysqlpass.stdout" 

- name: postfix database
  mysql_db:
    name: "{{ postfix_mysql_dbname }}"
    state: present
    login_host: "{{ postfix_mysql_host }}"
    login_user: root
    login_password: "{{ root_mysql_password }}"

- name: postfix user
  mysql_user:
    name: "{{ postfix_mysql_user }}"
    state: present
    password: "{{ postfix_mysql_password }}"
    priv: '{{ postfix_mysql_dbname }}.*:ALL'
    login_host: "{{ postfix_mysql_host }}"
    login_user: root
    login_password: "{{ root_mysql_password }}"

- name: roundcube database
  mysql_db:
    name: "{{ roundcube_mysql_dbname }}"
    state: present
    login_host: "{{ roundcube_mysql_host }}"
    login_user: root
    login_password: "{{ root_mysql_password }}"

- name: roundcube user
  mysql_user:
    name: "{{ roundcube_mysql_user }}"
    state: present
    password: "{{ roundcube_mysql_password }}"
    priv: '{{ roundcube_mysql_dbname }}.*:ALL'
    login_host: "{{ roundcube_mysql_host }}"
    login_user: root
    login_password: "{{ root_mysql_password }}"


...
